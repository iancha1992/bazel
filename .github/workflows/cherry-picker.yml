name: cherry-picker

on:
  pull_request_target:
    types: [closed]
  issues:
    types: [closed, milestoned]
  commit_comment:
    types: [created]

permissions:
  contents: read

env:
  GH_TOKEN: ${{ secrets.BAZEL_IO_TOKEN }}

jobs:
  cherry-picker-on-closed:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@63c24ba6bd7ba022e95695ff85de572c04a18142
        with:
          egress-policy: audit
      - if: github.event.pull_request
        name: Run cherrypicker on closed PR
        uses: iancha1992/continuous-integration/actions/cherry_picker@updatelockfile_PRs
        with:
          triggered-on: closed
          pr-number: ${{ github.event.number }}
          is-prod: False
      - if: github.event.issue
        name: Run cherrypicker on closed issue
        uses: iancha1992/continuous-integration/actions/cherry_picker@updatelockfile_PRs
        with:
          triggered-on: closed
          pr-number: ${{ github.event.issue.number }}
          is-prod: False
  cherry-picker-on-milestoned:
    if: github.event.action == 'milestoned'
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@63c24ba6bd7ba022e95695ff85de572c04a18142
        with:
          egress-policy: audit
      - if: startsWith(github.event.issue.body, 'Forked from')
        name: Run cherrypicker on comment
        uses: iancha1992/continuous-integration/actions/cherry_picker@updatelockfile_PRs
        with:
          triggered-on: commented
          pr-number: ${{ github.event.issue.body }}
          milestone-title: ${{ github.event.milestone.title }}
          milestoned-issue-number: ${{ github.event.issue.number }}
          is-prod: False
      - if: startsWith(github.event.issue.body, '### Commit IDs')
        name: Run cherrypicker on demand
        uses: iancha1992/continuous-integration/actions/cherry_picker@updatelockfile_PRs
        with:
          triggered-on: ondemand
          milestone-title: ${{ github.event.milestone.title }}
          milestoned-issue-number: ${{ github.event.issue.number }}
          issue-title: ${{ github.event.issue.title }}
          issue-body: ${{ github.event.issue.body }}
          is-prod: False

  cherry-picker-on-commit-comment:
    if: github.event_name == 'commit_comment' && startsWith(github.event.comment.body, 'bazel-io fork ')
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@63c24ba6bd7ba022e95695ff85de572c04a18142
        with:
          egress-policy: audit

      - name: Fetch Commit and Version Details
        id: info
        env:
          GH_TOKEN: ${{ secrets.BAZEL_IO_TOKEN }}
        run: |
          # 1. Extract version from comment (e.g., "bazel-io fork 10.2.3" -> "10.2.3")
          VERSION=$(echo "${{ github.event.comment.body }}" | sed 's/bazel-io fork //')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # 2. Fetch commit title and message body via API
          COMMIT_SHA=${{ github.event.comment.commit_id }}
          FULL_MSG=$(gh api repos/${{ github.repository }}/commits/$COMMIT_SHA --jq '.commit.message')

          # Separate title (1st line) and body (rest)
          TITLE=$(echo "$FULL_MSG" | head -n 1)
          BODY=$(echo "$FULL_MSG" | tail -n +3)

          # Use delimiters to handle multi-line bodies in outputs
          {
            echo "title=$TITLE"
            echo "body<<EOF"
            echo "### Commit IDs"
            echo "$COMMIT_SHA"
            echo ""
            echo "$BODY"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      # - name: Run cherrypicker on commit comment
      #   uses: iancha1992/continuous-integration/actions/cherry_picker@updatelockfile_PRs
      #   with:
      #     triggered-on: ondemand
      #     milestone-title: ${{ steps.info.outputs.version }}
      #     issue-title: ${{ steps.info.outputs.title }}
      #     issue-body: ${{ steps.info.outputs.body }}
      #     is-prod: False
